from mcp.server.fastmcp import FastMCP
from dotenv import load_dotenv
import os
import sys

# Ensure src path for imports
sys.path.append(os.path.abspath("src"))
from tools.workbench_bridge import WorkbenchBridge
from composio import Composio

# Initialize Configuration
load_dotenv()

try:
    mcp = FastMCP("Local Intelligence Toolkit")
except Exception:
    raise

# Initialize Bridge Lazy (or global)
# We need a Composio client context.
# In a real tool call, we might want to pass session info?
# For now, we use the environment variable config.


def get_bridge():
    # Instantiate fresh or cached
    client = Composio(api_key=os.environ.get("COMPOSIO_API_KEY"))
    # User ID defaults to standard; in production we might need to parameterize this
    return WorkbenchBridge(composio_client=client, user_id="user_123")


@mcp.tool()
def workbench_download(
    remote_path: str, local_path: str, session_id: str = None
) -> str:
    """
    Download a file from the Remote Composio Workbench to the Local Workspace.

    Use this when you need to bring remote data LOCAL for analysis, processing, or reporting.

    Args:
        remote_path: The absolute path of the file on the remote workbench (e.g. /home/user/data.csv)
        local_path: The relative or absolute path where to save it locally (e.g. ./data.csv)
        session_id: DEPRECATED - Not used. Session context is maintained by Composio client automatically.
                    The client created with composio.create(user_id) handles session state.

    Example:
        # After COMPOSIO_MULTI_EXECUTE_TOOL saves results to "/home/user/.composio/mex/some.json"
        workbench_download(
            remote_path="/home/user/.composio/mex/some.json",
            local_path="{CURRENT_SESSION_WORKSPACE}/research_data.json"
        )

    Best Practices:
        - Use ABSOLUTE paths with {CURRENT_SESSION_WORKSPACE} for local_path to keep files organized
        - Download BEFORE attempting local analysis or report generation
        - The Composio client handles session context automatically based on user_id
    """
    bridge = get_bridge()
    result = bridge.download(remote_path, local_path, session_id=session_id)
    if result.get("error"):
        return f"Error: {result['error']}"
    return f"Successfully downloaded {remote_path} to {local_path}. Local path: {result.get('local_path')}"


@mcp.tool()
def workbench_upload(local_path: str, remote_path: str, session_id: str = None) -> str:
    """
    Upload a file from the Local Workspace to the Remote Composio Workbench.

    Use this to send locally-generated files (reports, processed data) back to the remote workbench
    for further remote operations (e.g., email attachment via S3).

    Args:
        local_path: The path of the local file to upload (e.g. ./report.md)
        remote_path: The absolute destination path on the remote workbench (e.g. /home/user/report.md)
        session_id: OPTIONAL. The Composio Session ID where to upload the file.

    Example:
        # After local sub-agent generates report at "{CURRENT_SESSION_WORKSPACE}/work_products/report.html"
        workbench_upload(
            local_path="{CURRENT_SESSION_WORKSPACE}/work_products/report.html",
            remote_path="/home/user/report.html",
            session_id="your_session_id"
        )

        # Then use upload_local_file() in COMPOSIO_REMOTE_WORKBENCH to get S3 key for email attachment
    """
    bridge = get_bridge()
    result = bridge.upload(local_path, remote_path, session_id=session_id)
    if result.get("error"):
        return f"Error: {result['error']}"
    return f"Successfully uploaded {local_path} to {remote_path}."
    return f"Successfully uploaded {local_path} to {remote_path}."


@mcp.tool()
def write_local_file(path: str, content: str) -> str:
    """
    Write content to a file in the Local Workspace.
    Useful for saving reports, summaries, or code generated by sub-agents.

    Args:
        path: The relative or absolute path to write to (e.g. ./report.md).
              Relative paths are resolved relative to the current working directory.
        content: The text content to write to the file.

    Example:
        # Sub-agent saving a report
        write_local_file(
            path="{CURRENT_SESSION_WORKSPACE}/work_products/report.html",
            content="<html>...</html>"
        )

    Best Practices:
        - Use ABSOLUTE paths with {CURRENT_SESSION_WORKSPACE} for proper organization
        - The tool automatically creates parent directories if they don't exist
        - This runs LOCALLY (fast, no network latency)
    """
    try:
        # Resolve path
        abs_path = os.path.abspath(path)
        base_dir = os.getcwd()

        # Ensure directory exists
        os.makedirs(os.path.dirname(abs_path), exist_ok=True)

        with open(abs_path, "w", encoding="utf-8") as f:
            f.write(content)

        return f"Successfully wrote {len(content)} chars to {path}"
    except Exception as e:
        return f"Error writing file: {str(e)}"


if __name__ == "__main__":
    mcp.run()
