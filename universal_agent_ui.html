<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Universal Agent ‚Äî Neural Command Center</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@300;400;500;600&family=Outfit:wght@300;400;500;600;700&display=swap"
        rel="stylesheet">
    <style>
        :root {
            /* AGI-Era Color Palette - Brighter, More Vibrant */
            --bg-deep: #050507;
            --bg-panel: rgba(10, 12, 20, 0.92);
            --bg-card: rgba(15, 18, 30, 0.85);

            /* Primary: Brilliant Mint (upgraded from cyan) */
            --accent-primary: #00ffc8;
            --accent-primary-dim: rgba(0, 255, 200, 0.15);
            --accent-primary-glow: rgba(0, 255, 200, 0.5);

            /* Secondary: Deep Purple (AI/AGI association) */
            --accent-purple: #9d4edd;
            --accent-purple-dim: rgba(157, 78, 221, 0.15);

            /* Functional Colors */
            --accent-amber: #ffa500;
            --accent-magenta: #ff55a3;
            --accent-green: #00ff88;
            --accent-red: #ff4757;

            /* Text Hierarchy */
            --text-primary: #ffffff;
            --text-secondary: #b8c0d8;
            --text-muted: #6272a4;

            /* Effects */
            --border-glow: rgba(0, 255, 200, 0.6);
            --glass-blur: blur(24px);
            --shadow-glow: 0 0 40px rgba(0, 255, 200, 0.15);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Outfit', sans-serif;
            background: var(--bg-deep);
            color: var(--text-primary);
            min-height: 100vh;
            overflow: hidden;
        }

        /* Animated gradient background */
        .bg-gradient-animated {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg,
                    #050507 0%,
                    #0a0a12 25%,
                    #0d0815 50%,
                    #0a0a12 75%,
                    #050507 100%);
            background-size: 400% 400%;
            animation: gradientShift 15s ease infinite;
        }

        @keyframes gradientShift {
            0% {
                background-position: 0% 50%;
            }

            50% {
                background-position: 100% 50%;
            }

            100% {
                background-position: 0% 50%;
            }
        }

        /* Scanlines overlay for CRT/futuristic feel */
        .scanlines {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: repeating-linear-gradient(0deg,
                    transparent,
                    transparent 2px,
                    rgba(0, 255, 200, 0.01) 2px,
                    rgba(0, 255, 200, 0.01) 4px);
            pointer-events: none;
            z-index: 0;
        }

        .bg-grid {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image:
                linear-gradient(rgba(0, 255, 200, 0.05) 1px, transparent 1px),
                linear-gradient(90deg, rgba(0, 255, 200, 0.05) 1px, transparent 1px);
            background-size: 40px 40px;
            animation: gridPan 40s linear infinite;
        }

        @keyframes gridPan {
            0% {
                transform: translate(0, 0);
            }

            100% {
                transform: translate(40px, 40px);
            }
        }

        .bg-gradient-orb {
            position: fixed;
            border-radius: 50%;
            filter: blur(120px);
            opacity: 0.5;
            animation: orbFloat 12s ease-in-out infinite;
        }

        .orb-1 {
            width: 800px;
            height: 800px;
            background: radial-gradient(circle, rgba(0, 255, 200, 0.25) 0%, transparent 60%);
            top: -300px;
            right: -300px;
        }

        .orb-2 {
            width: 600px;
            height: 600px;
            background: radial-gradient(circle, rgba(157, 78, 221, 0.2) 0%, transparent 60%);
            bottom: -200px;
            left: -200px;
            animation-delay: -6s;
        }

        .orb-3 {
            width: 500px;
            height: 500px;
            background: radial-gradient(circle, rgba(255, 85, 163, 0.15) 0%, transparent 60%);
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            animation-delay: -3s;
        }

        @keyframes orbFloat {

            0%,
            100% {
                transform: translate(0, 0) scale(1);
                opacity: 0.5;
            }

            50% {
                transform: translate(50px, -50px) scale(1.2);
                opacity: 0.7;
            }
        }

        .particles {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 0;
            pointer-events: none;
        }

        .particle {
            position: absolute;
            width: 3px;
            height: 3px;
            background: var(--accent-primary);
            border-radius: 50%;
            opacity: 0;
            animation: particleFloat 8s ease-in-out infinite;
        }

        @keyframes particleFloat {
            0% {
                opacity: 0;
                transform: translateY(100vh) scale(0);
            }

            10% {
                opacity: 0.8;
            }

            90% {
                opacity: 0.8;
            }

            100% {
                opacity: 0;
                transform: translateY(-100px) scale(1);
            }
        }

        .container {
            position: relative;
            z-index: 1;
            display: grid;
            grid-template-columns: 320px 1fr 600px;
            grid-template-rows: auto 1fr auto;
            gap: 16px;
            height: 100vh;
            padding: 16px;
        }

        .panel {
            background: var(--bg-panel);
            backdrop-filter: var(--glass-blur);
            border: 1px solid rgba(0, 255, 200, 0.2);
            border-radius: 16px;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .panel:hover {
            border-color: var(--border-glow);
            box-shadow: 0 0 30px rgba(0, 255, 200, 0.1);
        }

        .panel-header {
            padding: 16px 20px;
            border-bottom: 1px solid rgba(0, 255, 200, 0.15);
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .panel-title {
            font-family: 'JetBrains Mono', monospace;
            font-size: 12px;
            font-weight: 500;
            letter-spacing: 2px;
            text-transform: uppercase;
            color: var(--accent-primary);
        }

        .panel-content {
            flex: 1;
            overflow-y: auto;
        }

        .panel-content::-webkit-scrollbar {
            width: 6px;
        }

        .panel-content::-webkit-scrollbar-thumb {
            background: rgba(0, 255, 200, 0.3);
            border-radius: 3px;
        }

        .header {
            grid-column: 1 / -1;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 16px 24px;
            background: var(--bg-panel);
            backdrop-filter: var(--glass-blur);
            border: 1px solid rgba(0, 255, 200, 0.2);
            border-radius: 16px;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .logo-text {
            font-family: 'JetBrains Mono', monospace;
        }

        .logo-text .primary {
            font-size: 20px;
            font-weight: 600;
            letter-spacing: 6px;
        }

        .status-bar {
            display: flex;
            gap: 24px;
            font-family: 'JetBrains Mono', monospace;
            font-size: 11px;
            color: var(--text-secondary);
        }

        .status-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--accent-primary);
            animation: pulse 2s ease-in-out infinite;
        }

        .status-indicator.processing {
            background: var(--accent-amber);
            animation: pulseAmber 1s ease-in-out infinite;
        }

        @keyframes pulse {

            0%,
            100% {
                opacity: 1;
                box-shadow: 0 0 10px var(--accent-primary);
            }

            50% {
                opacity: 0.5;
                box-shadow: 0 0 5px var(--accent-primary);
            }
        }

        @keyframes pulseAmber {

            0%,
            100% {
                opacity: 1;
                box-shadow: 0 0 15px var(--accent-amber);
            }

            50% {
                opacity: 0.3;
                box-shadow: 0 0 5px var(--accent-amber);
            }
        }

        .sidebar {
            grid-row: 2 / 4;
        }

        .session-list {
            padding: 12px;
        }

        .session-item {
            padding: 14px 16px;
            margin-bottom: 8px;
            border-radius: 12px;
            cursor: pointer;
            border: 1px solid transparent;
        }

        .session-item:hover {
            background: rgba(0, 255, 200, 0.08);
            border-color: rgba(0, 255, 200, 0.2);
        }

        .session-item.active {
            background: rgba(0, 255, 200, 0.15);
            border-color: var(--accent-primary);
        }

        .session-title {
            font-size: 14px;
            margin-bottom: 4px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .session-meta {
            display: flex;
            gap: 8px;
            font-family: 'JetBrains Mono', monospace;
            font-size: 10px;
            color: var(--text-muted);
        }

        .session-badge {
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 9px;
        }

        .session-badge.complex {
            background: rgba(255, 184, 108, 0.2);
            color: var(--accent-amber);
        }

        .session-badge.simple {
            background: rgba(80, 250, 123, 0.2);
            color: var(--accent-green);
        }

        .new-session-btn {
            margin: 12px;
            padding: 14px;
            border: 1px dashed rgba(0, 255, 200, 0.4);
            border-radius: 12px;
            background: transparent;
            color: var(--accent-primary);
            font-family: 'JetBrains Mono', monospace;
            cursor: pointer;
        }

        .sidebar-split {
            display: flex;
            flex-direction: column;
            height: 100%;
        }

        .sidebar-section {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            border-bottom: 1px solid rgba(0, 255, 200, 0.15);
        }

        .sidebar-section:last-child {
            border-bottom: none;
        }

        .sidebar-section-content {
            flex: 1;
            overflow-y: auto;
        }

        .file-browser {
            padding: 12px;
        }

        .file-path {
            font-family: 'JetBrains Mono', monospace;
            font-size: 10px;
            color: var(--text-muted);
            margin-bottom: 12px;
            padding: 8px 10px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 6px;
        }

        .path-segment {
            color: var(--text-secondary);
        }

        .path-segment.active {
            color: var(--accent-primary);
        }

        .path-sep {
            color: var(--text-muted);
            margin: 0 4px;
        }

        .file-list {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .file-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 12px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .file-item:hover {
            background: rgba(0, 255, 200, 0.08);
        }

        .file-item.folder .file-name {
            color: var(--accent-amber);
        }

        .file-icon {
            font-size: 14px;
        }

        .file-name {
            flex: 1;
            font-size: 12px;
            color: var(--text-primary);
        }

        .file-size,
        .file-count {
            font-family: 'JetBrains Mono', monospace;
            font-size: 10px;
            color: var(--text-muted);
        }

        .session-dropdown {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .session-select {
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(0, 255, 200, 0.3);
            border-radius: 8px;
            padding: 8px 12px;
            color: var(--text-primary);
            font-family: 'JetBrains Mono', monospace;
            font-size: 11px;
            cursor: pointer;
            min-width: 280px;
        }

        .session-select:focus {
            outline: none;
            border-color: var(--accent-primary);
        }

        .session-select option {
            background: var(--bg-deep);
            color: var(--text-primary);
        }

        .new-session-btn-header {
            width: 32px;
            height: 32px;
            border-radius: 8px;
            border: 1px dashed rgba(0, 255, 200, 0.4);
            background: transparent;
            color: var(--accent-primary);
            font-size: 18px;
            cursor: pointer;
        }

        .new-session-btn-header:hover {
            background: rgba(0, 255, 200, 0.1);
        }

        .chat-panel {
            grid-column: 2;
            grid-row: 2;
        }

        /* View Toggle between Chat and Output */
        .view-toggle {
            display: flex;
            gap: 8px;
            margin-left: auto;
        }

        .view-toggle-btn {
            padding: 6px 14px;
            border-radius: 8px;
            border: 1px solid rgba(0, 255, 200, 0.3);
            background: transparent;
            color: var(--text-muted);
            font-family: 'JetBrains Mono', monospace;
            font-size: 10px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .view-toggle-btn:hover {
            border-color: var(--accent-primary);
            color: var(--text-primary);
        }

        .view-toggle-btn.active {
            background: rgba(0, 255, 200, 0.15);
            border-color: var(--accent-primary);
            color: var(--accent-primary);
        }

        /* Output Panel */
        .output-panel {
            display: none;
            height: 100%;
            flex-direction: column;
        }

        .output-panel.active {
            display: flex;
        }

        .output-frame {
            flex: 1;
            width: 100%;
            border: none;
            border-radius: 12px;
            background: rgba(255, 255, 255, 0.98);
        }

        .output-placeholder {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            gap: 16px;
            color: var(--text-muted);
        }

        .output-placeholder svg {
            opacity: 0.3;
        }

        .chat-view {
            display: flex;
            flex-direction: column;
            height: 100%;
        }

        .chat-view.hidden {
            display: none;
        }

        /* Progress Indicator for Context Panel */
        .context-progress {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 16px;
            padding: 40px 20px;
            color: var(--text-muted);
        }

        .context-progress.hidden {
            display: none;
        }

        .progress-bars {
            display: flex;
            gap: 4px;
            align-items: flex-end;
            height: 30px;
        }

        .progress-bar {
            width: 4px;
            background: var(--accent-primary);
            border-radius: 2px;
            animation: progressPulse 1.2s ease-in-out infinite;
        }

        .progress-bar:nth-child(1) {
            animation-delay: 0s;
            height: 10px;
        }

        .progress-bar:nth-child(2) {
            animation-delay: 0.1s;
            height: 20px;
        }

        .progress-bar:nth-child(3) {
            animation-delay: 0.2s;
            height: 30px;
        }

        .progress-bar:nth-child(4) {
            animation-delay: 0.3s;
            height: 20px;
        }

        .progress-bar:nth-child(5) {
            animation-delay: 0.4s;
            height: 10px;
        }

        @keyframes progressPulse {

            0%,
            100% {
                opacity: 0.3;
                transform: scaleY(0.5);
            }

            50% {
                opacity: 1;
                transform: scaleY(1);
            }
        }

        .progress-text {
            font-size: 11px;
            letter-spacing: 1px;
            text-transform: uppercase;
        }

        .chat-columns {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
            height: 100%;
        }

        .chat-column {
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .chat-column-header {
            padding: 12px 16px;
            border-bottom: 1px solid rgba(0, 255, 200, 0.15);
            font-family: 'JetBrains Mono', monospace;
            font-size: 10px;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--text-muted);
        }

        .chat-column-content {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
        }

        .messages {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .context-items {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .context-item {
            background: rgba(0, 0, 0, 0.2);
            border: 1px solid rgba(0, 255, 200, 0.15);
            border-radius: 10px;
            padding: 14px;
        }

        .context-item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .context-item-type {
            font-family: 'JetBrains Mono', monospace;
            font-size: 10px;
            padding: 2px 8px;
            border-radius: 4px;
            background: rgba(255, 184, 108, 0.2);
            color: var(--accent-amber);
        }

        .context-item-content {
            font-size: 13px;
            color: var(--text-secondary);
            line-height: 1.5;
        }

        .context-item-content pre {
            background: rgba(0, 0, 0, 0.3);
            padding: 10px;
            border-radius: 6px;
            overflow-x: auto;
            font-family: 'JetBrains Mono', monospace;
            font-size: 11px;
        }

        .message {
            display: flex;
            gap: 16px;
            animation: messageSlide 0.3s ease-out;
        }

        @keyframes messageSlide {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .message.user {
            flex-direction: row-reverse;
        }

        .message-avatar {
            width: 40px;
            height: 40px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .message.agent .message-avatar {
            background: linear-gradient(135deg, var(--accent-primary-dim), rgba(0, 255, 200, 0.3));
            border: 1px solid var(--accent-primary);
        }

        .message.user .message-avatar {
            background: linear-gradient(135deg, rgba(255, 184, 108, 0.2), rgba(255, 121, 198, 0.2));
            border: 1px solid var(--accent-magenta);
        }

        .message-content {
            max-width: 70%;
        }

        .message-bubble {
            padding: 16px 20px;
            border-radius: 16px;
            line-height: 1.6;
        }

        .message.agent .message-bubble {
            background: rgba(0, 255, 200, 0.08);
            border: 1px solid rgba(0, 255, 200, 0.2);
            border-top-left-radius: 4px;
        }

        .message.user .message-bubble {
            background: rgba(255, 121, 198, 0.1);
            border: 1px solid rgba(255, 121, 198, 0.3);
            border-top-right-radius: 4px;
        }

        .message-meta {
            font-family: 'JetBrains Mono', monospace;
            font-size: 10px;
            color: var(--text-muted);
            margin-top: 6px;
        }

        .typing-indicator {
            display: flex;
            gap: 6px;
            padding: 16px 20px;
        }

        .typing-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--accent-primary);
            animation: typingBounce 1.4s ease-in-out infinite;
        }

        .typing-dot:nth-child(2) {
            animation-delay: 0.2s;
        }

        .typing-dot:nth-child(3) {
            animation-delay: 0.4s;
        }

        @keyframes typingBounce {

            0%,
            60%,
            100% {
                transform: translateY(0);
            }

            30% {
                transform: translateY(-8px);
            }
        }

        .input-panel {
            grid-column: 2;
            grid-row: 3;
            padding: 16px 24px 20px;
        }

        .input-wrapper {
            display: flex;
            gap: 12px;
            align-items: flex-end;
        }

        .input-container {
            flex: 1;
            position: relative;
        }

        .chat-input {
            width: 100%;
            min-height: 56px;
            padding: 16px 20px;
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(0, 255, 200, 0.3);
            border-radius: 16px;
            color: var(--text-primary);
            font-family: 'Outfit', sans-serif;
            font-size: 15px;
            resize: none;
        }

        .chat-input:focus {
            outline: none;
            border-color: var(--accent-primary);
            box-shadow: 0 0 20px rgba(0, 255, 200, 0.15);
        }

        .send-btn {
            width: 56px;
            height: 56px;
            border-radius: 16px;
            background: linear-gradient(135deg, var(--accent-primary), rgba(0, 255, 200, 0.7));
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--bg-deep);
        }

        .send-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 0 30px rgba(0, 255, 200, 0.4);
        }

        .neural-panel {
            grid-column: 3;
            grid-row: 2 / 4;
        }

        .neural-viz {
            height: 200px;
            position: relative;
        }

        .metrics-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            padding: 16px;
        }

        .metric-card {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 12px;
            padding: 16px;
            text-align: center;
        }

        .metric-value {
            font-family: 'JetBrains Mono', monospace;
            font-size: 24px;
            font-weight: 600;
            color: var(--accent-primary);
        }

        .metric-label {
            font-size: 10px;
            text-transform: uppercase;
            color: var(--text-muted);
            margin-top: 4px;
        }

        .activity-stream {
            padding: 16px;
        }

        .activity-section {
            margin-bottom: 24px;
        }

        .activity-section-title {
            font-family: 'JetBrains Mono', monospace;
            font-size: 10px;
            text-transform: uppercase;
            color: var(--text-muted);
            margin-bottom: 12px;
        }

        .activity-item {
            padding: 12px;
            margin-bottom: 8px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 10px;
            border-left: 2px solid;
        }

        .activity-item.tool {
            border-color: var(--accent-amber);
        }

        .activity-item.thought {
            border-color: var(--accent-primary);
        }

        .activity-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 6px;
        }

        .activity-type {
            font-family: 'JetBrains Mono', monospace;
            font-size: 10px;
            padding: 2px 8px;
            border-radius: 4px;
        }

        .activity-item.tool .activity-type {
            background: rgba(255, 184, 108, 0.2);
            color: var(--accent-amber);
        }

        .activity-item.thought .activity-type {
            background: rgba(0, 255, 200, 0.2);
            color: var(--accent-primary);
        }

        .activity-content {
            font-size: 13px;
            color: var(--text-secondary);
        }

        /* Latest Activity Detail Panel */
        .latest-activity-detail {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
            padding: 12px;
            max-height: 400px;
            overflow-y: auto;
        }

        .latest-activity-placeholder {
            color: var(--text-muted);
            font-style: italic;
            text-align: center;
            padding: 20px;
        }

        .latest-activity-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            padding-bottom: 8px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .latest-activity-type {
            font-family: 'JetBrains Mono', monospace;
            font-size: 10px;
            padding: 3px 10px;
            border-radius: 4px;
            text-transform: uppercase;
        }

        .latest-activity-type.tool {
            background: rgba(255, 184, 108, 0.2);
            color: var(--accent-amber);
        }

        .latest-activity-type.result {
            background: rgba(0, 255, 200, 0.2);
            color: var(--accent-primary);
        }

        .latest-activity-type.thought {
            background: rgba(189, 147, 249, 0.2);
            color: var(--accent-magenta);
        }

        .latest-activity-time {
            font-size: 10px;
            color: var(--text-muted);
        }

        .latest-activity-content {
            font-size: 12px;
            color: var(--text-secondary);
            line-height: 1.5;
            white-space: pre-wrap;
            word-break: break-word;
        }

        .processing-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(10, 11, 20, 0.8);
            backdrop-filter: blur(10px);
            z-index: 100;
            display: none;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            gap: 40px;
        }

        .processing-overlay.active {
            display: flex;
        }

        .processing-ring {
            width: 200px;
            height: 200px;
            position: relative;
        }

        @keyframes ringPulse {
            0% {
                stroke-dashoffset: 565;
            }

            50% {
                stroke-dashoffset: 100;
            }

            100% {
                stroke-dashoffset: 565;
            }
        }

        @keyframes orbit {
            from {
                transform: translate(-50%, -50%) rotate(0deg);
            }

            to {
                transform: translate(-50%, -50%) rotate(360deg);
            }
        }

        .processing-text {
            font-family: 'JetBrains Mono', monospace;
            font-size: 14px;
            color: var(--accent-primary);
            letter-spacing: 4px;
            text-transform: uppercase;
        }

        @media (max-width: 1100px) {
            .container {
                grid-template-columns: 1fr;
                grid-template-rows: auto 1fr auto auto;
            }

            .sidebar {
                grid-row: 4;
            }

            .neural-panel {
                grid-row: 3;
            }
        }
    </style>
</head>

<body>
    <!-- Enhanced AGI Background Effects -->
    <div class="bg-gradient-animated"></div>
    <div class="scanlines"></div>
    <div class="bg-grid"></div>
    <div class="bg-gradient-orb orb-1"></div>
    <div class="bg-gradient-orb orb-2"></div>
    <div class="bg-gradient-orb orb-3"></div>
    <div class="particles" id="particles"></div>

    <div class="container">
        <header class="header">
            <div class="logo">
                <svg width="48" height="48" viewBox="0 0 48 48">
                    <circle cx="24" cy="24" r="20" stroke="#00ffc8" stroke-width="2" fill="none" />
                    <circle cx="24" cy="24" r="12" stroke="#00ffc8" stroke-width="2" fill="none"
                        stroke-dasharray="4 4" />
                    <circle cx="24" cy="24" r="4" fill="#ff79c6" />
                </svg>
                <div class="logo-text">
                    <div class="primary">Universal Agent</div>
                    <div style="font-size: 11px; letter-spacing: 4px;">Neural Command Center</div>
                </div>
            </div>
            <div class="status-bar">
                <div style="display: flex; align-items: center; gap: 8px;">
                    <span class="status-indicator" id="statusIndicator"></span>
                    <span id="statusText">Ready</span>
                </div>
                <div>Model: <span style="color: var(--accent-magenta)">Sonnet 4.5</span></div>
                <div class="session-dropdown">
                    <select class="session-select" id="sessionSelect">
                        <option value="">New Session</option>
                    </select>
                    <button class="new-session-btn-header">+</button>
                </div>
            </div>
        </header>

        <aside class="panel sidebar">
            <div class="panel-header">
                <span class="panel-title">üìÅ Agent Workspace</span>
                <button class="refresh-btn" onclick="refreshFileList()" title="Refresh">üîÑ</button>
            </div>
            <div class="panel-content">
                <div class="file-browser">
                    <div class="file-path" id="filePath">
                        <span class="path-segment clickable" onclick="navigateToRoot()">workspace</span>
                    </div>
                    <div class="file-list" id="fileList">
                        <div class="file-loading">Loading files...</div>
                    </div>
                </div>
            </div>
        </aside>

        <main class="panel chat-panel">
            <div class="panel-header">
                <span class="panel-title">Neural Interface</span>
                <div class="view-toggle">
                    <button class="view-toggle-btn active" id="chatViewBtn" onclick="showChatView()">üí¨ Chat</button>
                    <button class="view-toggle-btn" id="outputViewBtn" onclick="showOutputView()">üìÑ Output</button>
                </div>
            </div>
            <div class="panel-content">

                <div class="chat-view" id="chatView">
                    <div class="chat-columns">
                        <!-- Left Column: Conversation -->
                        <div class="chat-column">
                            <div class="chat-column-header">üí¨ Conversation</div>
                            <div class="chat-column-content">
                                <div class="messages" id="messages">
                                    <div class="message agent">
                                        <div class="message-avatar">
                                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#00ffc8"
                                                stroke-width="2">
                                                <circle cx="12" cy="12" r="10" />
                                                <path d="M12 8v8M8 12h8" />
                                            </svg>
                                        </div>
                                        <div class="message-content">
                                            <div class="message-bubble">Hello Kevin! I'm Universal Agent, your
                                                autonomous AI assistant. I'm equipped with 500+ tool integrations and
                                                ready to help with research, reports, emails, and more. What would you
                                                like me to work on?</div>
                                            <div class="message-meta">Universal Agent ‚Ä¢ Ready</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Right Column: Context / Tool Outputs -->
                        <div class="chat-column">
                            <div class="chat-column-header">üîß Tool Outputs & Context</div>
                            <div class="chat-column-content">
                                <div class="context-items" id="contextItems">
                                    <!-- Dynamic context items appended here -->
                                </div>
                                <!-- Progress indicator at bottom where new items spawn -->
                                <div class="context-progress hidden" id="contextProgress">
                                    <div class="progress-bars">
                                        <div class="progress-bar"></div>
                                        <div class="progress-bar"></div>
                                        <div class="progress-bar"></div>
                                        <div class="progress-bar"></div>
                                        <div class="progress-bar"></div>
                                    </div>
                                    <div class="progress-text">Processing...</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div> <!-- end chat-view -->

            <!-- Output Panel (for HTML reports, videos, etc) -->
            <div class="output-panel" id="outputPanel">
                <div class="output-placeholder" id="outputPlaceholder">
                    <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1">
                        <rect x="3" y="3" width="18" height="18" rx="2" />
                        <path d="M3 9h18" />
                        <circle cx="7" cy="6" r="1" fill="currentColor" />
                        <circle cx="10" cy="6" r="1" fill="currentColor" />
                    </svg>
                    <span>Work products will appear here</span>
                </div>
                <iframe class="output-frame" id="outputFrame" style="display: none;"></iframe>
            </div>
        </main>

        <div class="panel input-panel">
            <div class="input-wrapper">
                <textarea class="chat-input" id="chatInput" placeholder="Transmit your request to the agent..."
                    rows="1"></textarea>
                <button class="send-btn">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                        stroke-width="2.5">
                        <line x1="22" y1="2" x2="11" y2="13" />
                        <polygon points="22 2 15 22 11 13 2 9 22 2" />
                    </svg>
                </button>
            </div>
        </div>

        <aside class="panel neural-panel">
            <div class="panel-header">
                <span class="panel-title">Neural Activity</span>
            </div>
            <canvas id="neuralCanvas" class="neural-viz"></canvas>
            <div class="metrics-grid">
                <div class="metric-card">
                    <div class="metric-value" id="toolCalls">0</div>
                    <div class="metric-label">Tool Calls</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value" id="tokenCount">0</div>
                    <div class="metric-label">Tokens</div>
                </div>
            </div>
            <div class="panel-content">
                <div class="activity-section">
                    <div class="activity-section-title">Latest Activity</div>
                    <div id="latestActivityDetail" class="latest-activity-detail">
                        <div class="latest-activity-placeholder">
                            Waiting for activity...
                        </div>
                    </div>
                </div>
            </div>
        </aside>
    </div>

    <script>
        const particlesContainer = document.getElementById('particles');
        for (let i = 0; i < 30; i++) {
            const p = document.createElement('div');
            p.className = 'particle';
            p.style.left = Math.random() * 100 + '%';
            p.style.animationDelay = Math.random() * 8 + 's';
            particlesContainer.appendChild(p);
        }
        const canvas = document.getElementById('neuralCanvas');
        const ctx = canvas.getContext('2d');
        canvas.width = canvas.offsetWidth;
        canvas.height = canvas.offsetHeight;
        const nodes = Array.from({ length: 20 }, () => ({
            x: Math.random() * canvas.width,
            y: Math.random() * canvas.height,
            vx: (Math.random() - 0.5) * 0.5,
            vy: (Math.random() - 0.5) * 0.5
        }));
        function animate() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            nodes.forEach(node => {
                node.x += node.vx;
                node.y += node.vy;
                if (node.x < 0 || node.x > canvas.width) node.vx *= -1;
                if (node.y < 0 || node.y > canvas.height) node.vy *= -1;
                ctx.beginPath();
                ctx.arc(node.x, node.y, 2, 0, Math.PI * 2);
                ctx.fillStyle = '#00ffc8';
                ctx.fill();
            });
            for (let i = 0; i < nodes.length; i++) {
                for (let j = i + 1; j < nodes.length; j++) {
                    const d = Math.hypot(nodes[i].x - nodes[j].x, nodes[i].y - nodes[j].y);
                    if (d < 60) {
                        ctx.beginPath();
                        ctx.moveTo(nodes[i].x, nodes[i].y);
                        ctx.lineTo(nodes[j].x, nodes[j].y);
                        ctx.strokeStyle = 'rgba(0, 255, 200, 0.15)';
                        ctx.stroke();
                    }
                }
            }
            requestAnimationFrame(animate);
        }
        animate();

        // =============================================================================
        // VIEW TOGGLE - Switch between Chat and Output panels
        // =============================================================================

        const chatView = document.getElementById('chatView');
        const outputPanel = document.getElementById('outputPanel');
        const outputFrame = document.getElementById('outputFrame');
        const outputPlaceholder = document.getElementById('outputPlaceholder');
        const chatViewBtn = document.getElementById('chatViewBtn');
        const outputViewBtn = document.getElementById('outputViewBtn');

        function showChatView() {
            chatView.classList.remove('hidden');
            outputPanel.classList.remove('active');
            chatViewBtn.classList.add('active');
            outputViewBtn.classList.remove('active');
        }

        function showOutputView() {
            chatView.classList.add('hidden');
            outputPanel.classList.add('active');
            chatViewBtn.classList.remove('active');
            outputViewBtn.classList.add('active');
        }

        // Simple markdown to HTML converter for chat messages
        function renderMarkdown(text) {
            if (!text) return '';
            return text
                // Escape HTML first
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                // Headers
                .replace(/^### (.+)$/gm, '<h4 style="color: var(--accent-primary); margin: 12px 0 6px;">$1</h4>')
                .replace(/^## (.+)$/gm, '<h3 style="color: var(--accent-primary); margin: 16px 0 8px;">$1</h3>')
                .replace(/^# (.+)$/gm, '<h2 style="color: var(--accent-primary); margin: 20px 0 10px;">$1</h2>')
                // Bold
                .replace(/\*\*(.+?)\*\*/g, '<strong style="color: var(--accent-magenta);">$1</strong>')
                // Italic
                .replace(/\*(.+?)\*/g, '<em>$1</em>')
                // Checkmarks and bullets
                .replace(/^- ‚úÖ (.+)$/gm, '<div style="margin: 4px 0; padding-left: 8px;">‚úÖ $1</div>')
                .replace(/^- (.+)$/gm, '<div style="margin: 4px 0; padding-left: 8px;">‚Ä¢ $1</div>')
                // Inline code
                .replace(/`([^`]+)`/g, '<code style="background: rgba(0,245,212,0.15); padding: 2px 6px; border-radius: 4px;">$1</code>')
                // Line breaks
                .replace(/\n\n/g, '<br><br>')
                .replace(/\n/g, '<br>');
        }

        // Load HTML content into output frame
        function loadOutputContent(htmlContent) {
            outputPlaceholder.style.display = 'none';
            outputFrame.style.display = 'block';
            outputFrame.srcdoc = htmlContent;
            // Auto-switch to output view when content loads
            showOutputView();
        }

        // Load URL into output frame
        function loadOutputUrl(url) {
            outputPlaceholder.style.display = 'none';
            outputFrame.style.display = 'block';
            outputFrame.src = url;
            showOutputView();
        }

        // =============================================================================
        // FILE BROWSER - Browse workspace files and open in output panel
        // =============================================================================

        const fileListEl = document.getElementById('fileList');
        const filePathEl = document.getElementById('filePath');
        let currentFilePath = '';  // Current directory path

        // Format file size
        function formatSize(bytes) {
            if (!bytes) return '';
            if (bytes < 1024) return bytes + ' B';
            if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
            return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
        }

        // Get icon for file type
        function getFileIcon(name, isDir) {
            if (isDir) return 'üìÇ';
            const ext = name.split('.').pop().toLowerCase();
            const icons = {
                'html': 'üåê',
                'json': 'üìã',
                'log': 'üìú',
                'txt': 'üìÑ',
                'md': 'üìù',
                'py': 'üêç',
                'js': 'üìú'
            };
            return icons[ext] || 'üìÑ';
        }

        // Render file path breadcrumb
        function renderFilePath(path) {
            const parts = path ? path.split('/').filter(p => p) : [];
            let html = '<span class="path-segment clickable" onclick="navigateToRoot()">workspace</span>';

            let accumulated = '';
            for (const part of parts) {
                accumulated += (accumulated ? '/' : '') + part;
                const pathForClick = accumulated;
                html += `<span class="path-sep">/</span>`;
                html += `<span class="path-segment clickable" onclick="navigateTo('${pathForClick}')">${part}</span>`;
            }

            filePathEl.innerHTML = html;
        }

        // Render file list
        function renderFileList(files) {
            if (!files || files.length === 0) {
                fileListEl.innerHTML = '<div class="file-empty">No files</div>';
                return;
            }

            // Sort: folders first, then files alphabetically
            files.sort((a, b) => {
                if (a.is_dir && !b.is_dir) return -1;
                if (!a.is_dir && b.is_dir) return 1;
                return a.name.localeCompare(b.name);
            });

            let html = '';

            // Add ".." to go up if not at root
            if (currentFilePath) {
                html += `<div class="file-item folder" onclick="navigateUp()">
                    <span class="file-icon">üìÅ</span>
                    <span class="file-name">..</span>
                    <span class="file-size"></span>
                </div>`;
            }

            for (const file of files) {
                const icon = getFileIcon(file.name, file.is_dir);
                const size = file.is_dir ?
                    (file.children !== null ? file.children + ' items' : '') :
                    formatSize(file.size);
                const classes = `file-item ${file.is_dir ? 'folder' : ''}`;
                const onclick = file.is_dir ?
                    `navigateTo('${file.path}')` :
                    `openFile('${file.path}')`;

                html += `<div class="${classes}" onclick="${onclick}">
                    <span class="file-icon">${icon}</span>
                    <span class="file-name">${file.name}</span>
                    <span class="file-size">${size}</span>
                </div>`;
            }

            fileListEl.innerHTML = html;
        }

        // Fetch and display files
        async function fetchFiles(path = '') {
            fileListEl.innerHTML = '<div class="file-loading">Loading...</div>';

            try {
                const url = '/api/files' + (path ? '?path=' + encodeURIComponent(path) : '');
                const response = await fetch(url);
                const data = await response.json();

                if (data.error) {
                    fileListEl.innerHTML = `<div class="file-error">${data.error}</div>`;
                    return;
                }

                currentFilePath = path;
                renderFilePath(path);
                renderFileList(data.files);
            } catch (err) {
                fileListEl.innerHTML = `<div class="file-error">Failed to load files</div>`;
                console.error('File fetch error:', err);
            }
        }

        // Navigation functions
        function navigateToRoot() {
            fetchFiles('');
        }

        function navigateTo(path) {
            fetchFiles(path);
        }

        function navigateUp() {
            const parts = currentFilePath.split('/');
            parts.pop();
            fetchFiles(parts.join('/'));
        }

        function refreshFileList() {
            fetchFiles(currentFilePath);
        }

        // Open file in output panel
        async function openFile(path) {
            const ext = path.split('.').pop().toLowerCase();

            // Construct the API URL - path comes in as relative (e.g., work_products/report.html)
            const apiUrl = '/api/file/' + path;

            // For HTML files, load directly in iframe
            if (ext === 'html') {
                outputPlaceholder.style.display = 'none';
                outputFrame.style.display = 'block';
                outputFrame.src = apiUrl;
                showOutputView();
                return;
            }

            // For other files, fetch and display as text/JSON
            try {
                const response = await fetch(apiUrl);
                const contentType = response.headers.get('content-type');

                if (contentType && contentType.includes('application/json')) {
                    const data = await response.json();
                    const html = `<html><head><style>
                        body { font-family: monospace; padding: 20px; background: #1a1b26; color: #a9b1d6; }
                        pre { white-space: pre-wrap; word-wrap: break-word; }
                    </style></head><body><pre>${JSON.stringify(data, null, 2)}</pre></body></html>`;
                    loadOutputContent(html);
                } else {
                    const text = await response.text();
                    const html = `<html><head><style>
                        body { font-family: monospace; padding: 20px; background: #1a1b26; color: #a9b1d6; }
                        pre { white-space: pre-wrap; word-wrap: break-word; }
                    </style></head><body><pre>${text.replace(/</g, '&lt;').replace(/>/g, '&gt;')}</pre></body></html>`;
                    loadOutputContent(html);
                }
            } catch (err) {
                console.error('File open error:', err);
            }
        }

        // Load files on page load (after WebSocket connects to get workspace)
        setTimeout(() => fetchFiles(''), 1000);

        // =============================================================================
        // WEBSOCKET CLIENT - Connect to Universal Agent Backend
        // =============================================================================

        const WS_URL = 'ws://localhost:8000/ws/chat';
        let ws = null;
        let toolCallCount = 0;

        // DOM Elements
        const statusIndicator = document.getElementById('statusIndicator');
        const statusText = document.getElementById('statusText');
        const messagesContainer = document.getElementById('messages');
        const contextItems = document.getElementById('contextItems');
        const chatInput = document.getElementById('chatInput');
        const sendBtn = document.querySelector('.send-btn');
        const toolCallsEl = document.getElementById('toolCalls');
        const activityStream = document.querySelector('.activity-stream .activity-section');

        // Helper: Create message element
        function createMessage(text, isUser = false) {
            const msg = document.createElement('div');
            msg.className = `message ${isUser ? 'user' : 'agent'}`;
            const now = new Date().toLocaleTimeString('en-US', { hour12: false });
            const avatar = isUser ?
                '<path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2" /><circle cx="12" cy="7" r="4" />' :
                '<circle cx="12" cy="12" r="10" /><path d="M12 8v8M8 12h8" />';
            const color = isUser ? '#ff79c6' : '#00ffc8';
            msg.innerHTML = `
                <div class="message-avatar">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="${color}" stroke-width="2">${avatar}</svg>
                </div>
                <div class="message-content">
                    <div class="message-bubble">${text}</div>
                    <div class="message-meta">${isUser ? 'You' : 'Universal Agent'} ‚Ä¢ ${now}</div>
                </div>
            `;
            return msg;
        }

        // Helper: Add activity item - updates the Latest Activity detail panel
        const latestActivityDetail = document.getElementById('latestActivityDetail');

        function addActivity(type, content, fullContent = null) {
            if (!latestActivityDetail) return;

            const timestamp = new Date().toLocaleTimeString('en-US', { hour12: false });
            const displayContent = fullContent || content;

            latestActivityDetail.innerHTML = `
                <div class="latest-activity-header">
                    <span class="latest-activity-type ${type.toLowerCase()}">${type}</span>
                    <span class="latest-activity-time">${timestamp}</span>
                </div>
                <div class="latest-activity-content">${displayContent}</div>
            `;
        }

        // Helper: Add context item (tool output)
        const contextProgress = document.getElementById('contextProgress');

        function addContextItem(type, content, color = 'amber') {
            // Hide progress indicator when first content arrives
            if (contextProgress) {
                contextProgress.classList.add('hidden');
            }

            const item = document.createElement('div');
            item.className = 'context-item';
            const colorMap = {
                'amber': 'rgba(255, 184, 108, 0.2)',
                'cyan': 'rgba(0, 255, 200, 0.2)',
                'green': 'rgba(80, 250, 123, 0.2)'
            };
            const textColorMap = {
                'amber': 'var(--accent-amber)',
                'cyan': 'var(--accent-primary)',
                'green': 'var(--accent-green)'
            };
            const timestamp = new Date().toLocaleTimeString('en-US', { hour12: false });
            item.innerHTML = `
                <div class="context-item-header">
                    <span class="context-item-type" style="background: ${colorMap[color]}; color: ${textColorMap[color]}">${type}</span>
                    <span style="font-size: 9px; color: var(--text-muted)">${timestamp}</span>
                </div>
                <div class="context-item-content">${content}</div>
            `;
            if (contextItems) {
                contextItems.appendChild(item);
                item.scrollIntoView({ behavior: 'smooth', block: 'end' });
            }

            // Update sidebar with full content (untruncated)
            const activityType = type.includes('RESULT') ? 'RESULT' : 'TOOL';
            addActivity(activityType, type, content);
        }

        // Connect to WebSocket
        function connect() {
            ws = new WebSocket(WS_URL);

            ws.onopen = () => {
                statusIndicator.classList.remove('processing');
                statusText.textContent = 'Connected';
                console.log('WebSocket connected');
            };

            ws.onclose = () => {
                statusText.textContent = 'Disconnected';
                setTimeout(connect, 3000); // Reconnect after 3s
            };

            ws.onerror = (err) => {
                console.error('WebSocket error:', err);
                statusText.textContent = 'Connection Error';
            };

            ws.onmessage = (event) => {
                const msg = JSON.parse(event.data);
                handleServerMessage(msg);
            };
        }

        // Handle messages from server
        function handleServerMessage(msg) {
            switch (msg.type) {
                case 'session_info':
                    console.log('Session:', msg.data);
                    // Refresh file browser with new workspace
                    if (msg.data.workspace) {
                        setTimeout(() => fetchFiles(''), 100);
                    }
                    break;

                case 'text':
                    const newText = msg.data.text;

                    // Filter out tool execution logs - redirect to context panel
                    const toolLogPatterns = [
                        /Executing on server\.\.\./,
                        /^Input:\s*```/,
                    ];

                    const isToolLog = toolLogPatterns.some(pattern => pattern.test(newText));
                    if (isToolLog) {
                        // Extract tool name and show in context panel instead
                        const toolMatch = newText.match(/Tool:\s*(\w+)/);
                        if (toolMatch) {
                            addContextItem('üîß ' + toolMatch[1], 'Executing...', 'amber');
                        }
                        break;  // Don't add to chat
                    }

                    // Skip empty or whitespace-only text
                    if (!newText.trim()) break;

                    let lastAgent = messagesContainer.querySelector('.message.agent:last-of-type');

                    // Check if we should start a new bubble:
                    // - No existing bubble or last is complete
                    // - New paragraph starts (double newline)
                    // - Markdown header starts (# ## ###)
                    // - Key section markers
                    const trimmedText = newText.trim();
                    const isNewSection =
                        trimmedText.startsWith('## ') ||
                        trimmedText.startsWith('### ') ||
                        trimmedText.startsWith('**Key') ||
                        trimmedText.startsWith('**What') ||
                        trimmedText.startsWith('**Report') ||
                        trimmedText.startsWith('---');

                    const shouldNewBubble = !lastAgent ||
                        lastAgent.dataset.complete === 'true' ||
                        (newText.startsWith('\n\n') && lastAgent.dataset.rawText?.length > 50) ||
                        (isNewSection && lastAgent.dataset.rawText?.length > 100);

                    if (shouldNewBubble) {
                        lastAgent = createMessage('');
                        lastAgent.dataset.rawText = '';
                        messagesContainer.appendChild(lastAgent);
                    }

                    const bubble = lastAgent.querySelector('.message-bubble');
                    // Accumulate raw text and re-render markdown
                    lastAgent.dataset.rawText = (lastAgent.dataset.rawText || '') + newText;
                    bubble.innerHTML = renderMarkdown(lastAgent.dataset.rawText);
                    // Smooth scroll to keep new content visible
                    lastAgent.scrollIntoView({ behavior: 'smooth', block: 'end' });
                    break;

                case 'tool_call':
                    toolCallCount++;
                    if (toolCallsEl) toolCallsEl.textContent = toolCallCount;
                    statusIndicator.classList.add('processing');

                    // Get short tool name
                    const fullName = msg.data.name || '';
                    const shortName = fullName.replace('mcp__composio__', '').replace('mcp__local_toolkit__', '');

                    statusText.textContent = `Calling ${shortName}...`;

                    // Show tool call with parameters in context panel
                    let paramsStr = '';
                    if (msg.data.input) {
                        try {
                            const params = typeof msg.data.input === 'string' ? JSON.parse(msg.data.input) : msg.data.input;
                            const keys = Object.keys(params).slice(0, 5);
                            paramsStr = keys.map(k => {
                                let v = params[k];
                                // Properly stringify objects and arrays
                                if (typeof v === 'object' && v !== null) {
                                    v = JSON.stringify(v);
                                }
                                // Truncate long values
                                if (typeof v === 'string' && v.length > 100) v = v.substring(0, 100) + '...';
                                return `<b>${k}:</b> ${v}`;
                            }).join('<br>');
                        } catch (e) {
                            paramsStr = JSON.stringify(msg.data.input).substring(0, 200);
                        }
                    }

                    addContextItem('üîß ' + shortName, paramsStr || 'Executing...', 'amber');
                    addActivity('TOOL', `${shortName}`);
                    break;

                case 'tool_result':
                    statusIndicator.classList.remove('processing');
                    statusText.textContent = 'Processing';
                    const preview = msg.data.content_preview || 'Complete';
                    const isError = msg.data.is_error;
                    addContextItem(isError ? '‚ùå ERROR' : '‚úÖ RESULT', preview, isError ? 'amber' : 'cyan');
                    break;

                case 'thinking':
                    addActivity('THOUGHT', msg.data.thinking?.substring(0, 100) + '...');
                    break;

                case 'auth_required':
                    const link = msg.data.auth_link;
                    addContextItem('AUTH REQUIRED', `<a href="${link}" target="_blank" style="color: var(--accent-magenta)">Click to authenticate</a>`, 'amber');
                    break;

                case 'query_complete':
                    statusIndicator.classList.remove('processing');
                    statusText.textContent = 'Ready';
                    // Hide progress indicator when query is done
                    if (contextProgress) {
                        contextProgress.classList.add('hidden');
                    }
                    // Mark last agent message as complete
                    const lastAgentMsg = messagesContainer.querySelector('.message.agent:last-of-type');
                    if (lastAgentMsg) lastAgentMsg.dataset.complete = 'true';

                    // Save final summary as work product
                    try {
                        const allAgentMsgs = messagesContainer.querySelectorAll('.message.agent');
                        if (allAgentMsgs.length > 0) {
                            // Collect all agent message text from this session
                            let fullSummary = '';
                            allAgentMsgs.forEach((m, i) => {
                                const rawText = m.dataset.rawText || m.querySelector('.message-bubble')?.textContent || '';
                                if (rawText.trim()) {
                                    fullSummary += rawText + '\n\n---\n\n';
                                }
                            });

                            // Only save if summary is substantial
                            if (fullSummary.length > 200) {
                                fetch('/api/save_summary', {
                                    method: 'POST',
                                    headers: { 'Content-Type': 'application/json' },
                                    body: JSON.stringify({ summary: fullSummary.trim() })
                                }).then(r => r.json()).then(data => {
                                    if (data.path) {
                                        addContextItem('üìù SUMMARY SAVED', data.path.split('/').pop(), 'green');
                                        setTimeout(() => fetchFiles(''), 500);
                                    }
                                }).catch(err => console.log('Summary save:', err));
                            }
                        }
                    } catch (e) { console.log('Summary save error:', e); }
                    break;

                case 'error':
                    addContextItem('ERROR', msg.data.message, 'amber');
                    break;

                case 'work_product':
                    // HTML report or other rich content - load into output panel
                    if (msg.data.content_type === 'text/html') {
                        loadOutputContent(msg.data.content);
                        addContextItem('REPORT READY', msg.data.filename || 'View in Output panel', 'green');
                    } else if (msg.data.url) {
                        loadOutputUrl(msg.data.url);
                        addContextItem('FILE READY', msg.data.filename || 'View in Output panel', 'green');
                    }
                    break;
            }
        }

        // Send query
        function sendQuery() {
            const text = chatInput.value.trim();
            if (!text || !ws || ws.readyState !== WebSocket.OPEN) return;

            // Add user message to UI
            const userMsg = createMessage(text, true);
            messagesContainer.appendChild(userMsg);
            userMsg.scrollIntoView({ behavior: 'smooth', block: 'end' });

            // Show progress indicator in context panel
            if (contextProgress) {
                contextProgress.classList.remove('hidden');
            }

            // Send to server
            ws.send(JSON.stringify({ type: 'query', content: text }));

            // Clear input
            chatInput.value = '';

            // Update status
            statusIndicator.classList.add('processing');
            statusText.textContent = 'Processing...';
        }

        // Event listeners
        sendBtn.addEventListener('click', sendQuery);
        chatInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendQuery();
            }
        });

        // Auto-resize textarea
        chatInput.addEventListener('input', () => {
            chatInput.style.height = 'auto';
            chatInput.style.height = Math.min(chatInput.scrollHeight, 150) + 'px';
        });

        // Connect on load
        connect();
    </script>

</body>

</html>