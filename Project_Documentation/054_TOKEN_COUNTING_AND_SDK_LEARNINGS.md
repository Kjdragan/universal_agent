# Token Counting and SDK Learnings

## Overview
Accurate token counting is critical for the Universal Agent's "Harness" architecture. It drives the `TRUNCATION_THRESHOLD` logic (set to 180,000 tokens) that triggers a harness iteration (context reset). This document details how we correctly extract and persist usage data using the `ClaudeAgentSDK`.

## Key Learnings from ClaudeAgentSDK

### 1. `AssistantMessage` vs. `ResultMessage`
Initially, we attempted to extract `usage` statistics from `AssistantMessage` objects. However, debugging revealed that:
*   `AssistantMessage`: Contains the streaming content blocks (Text, ToolUse) but **does not** contain the `usage` field in the final message object yielded by `receive_response()`.
*   `ResultMessage`: This is a specific message type yielded at the **end of a turn**. It explicitly contains the execution metrics, including cost, duration, and most importantly, `usage`.

### 2. The `ResultMessage` Structure
The `ResultMessage` object provides the authoritative source for token consumption for a given interaction turn.

```python
@dataclass
class ResultMessage:
    subtype: str
    duration_ms: int
    duration_api_ms: int
    is_error: bool
    num_turns: int
    session_id: str
    total_cost_usd: float | None = None
    usage: dict[str, Any] | None = None  # <--- CRITICAL FIELD
    result: str | None = None
```

The `usage` dictionary typically contains:
*   `input_tokens`: Tokens sent to the model.
*   `output_tokens`: Tokens generated by the model.
*   `cache_creation_input_tokens`: (Optional) Tokens used to create cache.
*   `cache_read_input_tokens`: (Optional) Tokens read from cache.

## Implementation in Universal Agent

### Extraction Logic in `main.py`
To correctly capture token usage, we updated the `process_turn` loop in `src/universal_agent/main.py` to listen for `ResultMessage`.

**Previous (Incorrect) Approach:**
Checked `AssistantMessage` for `usage` attribute -> Always returned `MISSING` or `None`.

**Corrected Approach:**
```python
async for msg in client.receive_response():
    if isinstance(msg, ResultMessage):
        # Track token usage from the final ResultMessage of the turn
        if hasattr(msg, "usage") and msg.usage:
            u = msg.usage
            inp = u.get("input_tokens", 0) or 0
            out = u.get("output_tokens", 0) or 0
            
            # Update local trace counters
            if trace and "token_usage" in trace:
                trace["token_usage"]["input"] += inp
                trace["token_usage"]["output"] += out
                trace["token_usage"]["total"] += (inp + out)
```

### Persistence
The accumulated token counts are stored in the `trace["token_usage"]` dictionary and saved to `trace.json` at the end of the run. This allows the harness (and external tools like the `verify_harness.py` script) to validate that the agent is aware of its context window usage.

## Reference
*   **ClaudeAgentSDK Python Reference**: See the `ResultMessage` class definition in the SDK documentation.
*   **Source Code**: `src/universal_agent/agent_core.py` (Message type imports) and `src/universal_agent/main.py` (Extraction logic).
