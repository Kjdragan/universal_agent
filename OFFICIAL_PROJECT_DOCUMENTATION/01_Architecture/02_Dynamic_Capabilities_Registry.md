# 02. Dynamic Capabilities Registry

## Overview

The **Dynamic Capabilities Registry** is a self-documenting system that generates a `capabilities.md` file in every agent session workspace. This file serves as the single source of truth for the agent's available skills, sub-agents, and tools, ensuring the agent is always aware of its current capabilities without hallucinating non-existent tools.

## Key Components

### 1. The Registry File (`capabilities.md`)

Located at `src/universal_agent/prompt_assets/capabilities.md` (and copied to session workspaces), this file is automatically generated at agent startup. It contains:

- **Skills**: A list of available Standard Operating Procedures (SOPs) found in `.claude/skills`.
- **Specialist Agents**: A list of available sub-agents (e.g., `research-specialist`, `video-creation-expert`).
- **Tools & Apps**:
  - **Connected Toolkits**: Integrations with active connections (e.g., Google Calendar, Sheets).
  - **Core Utilities**: Standard system tools (e.g., Code Interpreter, Filetool).
  - **MCP Servers**: Active Model Context Protocol servers and their tools.

### 2. AgentSetup Integration

The generation logic is embedded in `AgentSetup.initialize()`. This ensures that whether the agent is started via CLI, API, or Cron, the registry is always fresh and accurate for that specific environment.

### 3. Dynamic Internal Tool Discovery

To prevent drift between the documentation and the actual code, internal tools are defined in a central registry:

- **Source**: `src/universal_agent/tools/internal_registry.py`
- **Mechanism**: The `get_internal_tool_slugs()` function dynamically lists all registered internal tools (e.g., `run_research_pipeline`, `crawl_parallel`).
- **Benefit**: If a tool is added or removed from the code, it automatically appears or disappears from the documentation upon the next restart.

## How It Works

1. **Startup**: When `AgentSetup` initializes, it calls `_generate_capabilities_doc()`.
2. **Discovery**:
    - **Skills**: Scans `.claude/skills` for `SKILL.md` files.
    - **Agents**: Scans agent directories.
    - **Composio**: Fetches connected apps and their metadata (descriptions, categories).
    - **Internal**: Calls `internal_registry.get_internal_tool_slugs()`.
3. **Generation**: Formats this data into a structured Markdown file (`capabilities.md`).
4. **Context Injection**: The System Prompt includes a reference to this file, instructing the agent to "Read your capabilities.md file to understand what you can do."

## Benefits

- **Reduced Hallucinations**: The agent only sees tools that are actually available and connected.
- **Self-Correction**: If a tool requires a missing connection, the agent can see it's missing from the "Connected Toolkits" section.
- **Maintenance**: Developers don't need to manually update a static list of tools in the prompt; the code is the documentation.
